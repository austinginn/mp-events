<!DOCTYPE html>
<html lang="en" >

<head>

  <meta charset="UTF-8">
   <meta name="apple-mobile-web-app-capable" content="yes">

  <title>client testing</title>

</head>

<body translate="no" >

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
  <script >

  const queryString = window.location.search;
  console.log(queryString);
  const urlParams = new URLSearchParams(queryString);
  var code = urlParams.get('code');
  var state = urlParams.get('session_state');
  console.log(code);

  $.ajax({
    type: "POST",
    url: "https://afumc.ministryplatform.com/ministryplatformapi/oauth/connect/token",
    data: {
      'grant_type': "authorization_code",
      // 'client_id': "directory",
      // 'client_secret': "test",
      'code': code,
      'scope': "openid http://www.thinkministry.com/dataplatform/scopes/all",
      'redirect_uri' : "http://161.35.98.102/api/token/send/",
      // 'session_state' : state,
      'client_id': "directory",
      'client_secret': "test"
    },
    success: function(data)
    {
      console.log(data.access_token);
      $.ajax({
        type: "POST",
        headers: {"Authorization": "Bearer " + data.access_token},
        url: "https://afumc.ministryplatform.com/ministryplatformapi/oauth/connect/userinfo",
        data: {},
        success: function(data)
        {
          console.log(data);
          console.log(data.ext_Conctact_ID);
          //get api access
          $.ajax({
            type: "POST",
            url: "http://161.35.98.102/api/access",
            data: {
              'cid': data.ext_Contact_ID
            },
            success: function(newData){
              console.log(newData);
              window.location.replace("http://161.35.98.102/directory?session=" + newData);
            },
            error: function(newData){
              console.log(newData);
            }
          });
        },
        error: function(data){
          console.log(data)
        }
      });
    },
    error: function(data){
      console.log(data)
    }
  });

  </script>



</body>

</html>
